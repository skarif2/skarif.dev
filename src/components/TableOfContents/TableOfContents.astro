---
import type { MarkdownHeading } from 'astro';
import './TableOfContents.css';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// Filter out h1 (usually the title) and limit depth if needed
const tocHeadings = headings.filter((heading) => heading.depth > 1 && heading.depth < 4);

// Create array with Introduction + all headings for the mini indicator
const allHeadings = [
  { slug: 'introduction', text: 'Introduction', depth: 2 },
  ...tocHeadings
];
---

<!-- Mini TOC Indicator (mobile only) -->
<button class="toc-mini" id="toc-mini" aria-label="Table of contents">
  {allHeadings.map((heading) => (
    <span 
      class={`toc-mini-line depth-${heading.depth}`} 
      data-href={`#${heading.slug}`}
    ></span>
  ))}
</button>

<!-- Overlay for drawer -->
<div class="toc-overlay" id="toc-overlay"></div>

<!-- Full TOC (desktop sidebar / mobile drawer) -->
<nav class="toc" id="toc">
  <h2 class="toc-title">On This Page</h2>
  <ul class="toc-list">
    <li class="toc-item">
      <a href="#introduction" class="toc-link">Introduction</a>
    </li>
    {tocHeadings.map((heading) => (
      <li class={`toc-item depth-${heading.depth}`}>
        <a href={`#${heading.slug}`} class="toc-link">
          {heading.text}
        </a>
      </li>
    ))}
  </ul>
</nav>

<script>
  document.addEventListener('astro:page-load', () => {
    const tocMini = document.getElementById('toc-mini');
    const toc = document.getElementById('toc');

    if (tocMini && toc) {
      // Toggle drawer on mini indicator click
      tocMini.addEventListener('click', () => {
        toc.classList.toggle('is-open');
        document.body.style.overflow = toc.classList.contains('is-open') ? 'hidden' : '';
      });

      // Close when clicking outside (like sidebar)
      document.addEventListener('click', (e) => {
        if (toc.classList.contains('is-open') && 
            !toc.contains(e.target as Node) && 
            !tocMini.contains(e.target as Node)) {
          toc.classList.remove('is-open');
          document.body.style.overflow = '';
        }
      });

      // Close on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && toc.classList.contains('is-open')) {
          toc.classList.remove('is-open');
          document.body.style.overflow = '';
        }
      });

      // Close drawer when clicking a link
      toc.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', () => {
          toc.classList.remove('is-open');
          document.body.style.overflow = '';
        });
      });
    }

    // Scroll Spy logic
    const onScroll = () => {
      const headers = document.querySelectorAll('h2[id], h3[id]');
      let activeId = 'introduction';
      const offset = 120;

      for (const header of headers) {
        const rect = header.getBoundingClientRect();
        if (rect.top <= offset) {
          activeId = header.id;
        } else {
          break;
        }
      }

      // Update text TOC links
      const currentActive = document.querySelector('.toc-link.active');
      if (currentActive?.getAttribute('href') !== `#${activeId}`) {
        document.querySelectorAll('.toc-link').forEach(link => link.classList.remove('active'));
        const newActive = document.querySelector(`.toc-link[href="#${activeId}"]`);
        newActive?.classList.add('active');
      }

      // Update mini TOC lines
      const currentActiveLine = document.querySelector('.toc-mini-line.active');
      if (currentActiveLine?.getAttribute('data-href') !== `#${activeId}`) {
        document.querySelectorAll('.toc-mini-line').forEach(line => line.classList.remove('active'));
        const newActiveLine = document.querySelector(`.toc-mini-line[data-href="#${activeId}"]`);
        newActiveLine?.classList.add('active');
      }
    };

    window.addEventListener('scroll', () => {
      window.requestAnimationFrame(onScroll);
    });

    onScroll();
  });
</script>
