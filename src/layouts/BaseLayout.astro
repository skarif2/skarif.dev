---
import '../styles/global.css';
import Sidebar from '../components/Sidebar/Sidebar.astro';
import TopBar from '../components/TopBar/TopBar.astro';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title?: string;
  description?: string;
  currentPath?: string;
}

const {
  title = 'skarif.dev',
  description = 'Software engineer and open-source creator. This is my digital garden.',
  currentPath = '/'
} = Astro.props;

const fullTitle = title === 'skarif.dev' ? title : `${title} | skarif.dev`;
---

<!doctype html>
<html lang="en" class="is-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Sk Arif" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

    <!-- Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="05759b66-a50c-4814-886f-32b7777e9bd9"></script>

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    
    <title>{fullTitle}</title>
    
    <!-- View Transitions for smooth navigation -->
    <ViewTransitions />
    
    <!-- Theme initialization script (runs before page render to prevent flash) -->
    <script is:inline>
      // Restore theme from localStorage before page renders
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        
        // Define colors matching CSS variables
        const colors = {
          'Lavender': 'var(--theme-lavender)',
          'Pink': 'var(--theme-pink)',
          'Yellow': 'var(--theme-yellow)',
          'Green': 'var(--theme-green)',
          'Blue': 'var(--theme-blue)'
        };
        
        // Check both storage keys (theme-color from SettingsPanel, color from legacy)
        const savedColorName = localStorage.getItem('theme-color');
        const savedColorVal = localStorage.getItem('color');
        
        let colorToApply = 'var(--theme-lavender)';
        
        if (savedColorName && colors[savedColorName]) {
          colorToApply = colors[savedColorName];
        } else if (savedColorVal) {
          colorToApply = savedColorVal;
        }

        const html = document.documentElement;
        html.style.setProperty('color-scheme', savedTheme);
        
        if (savedTheme === 'light') {
          html.classList.add('is-light');
          html.classList.remove('is-dark');
        } else {
          html.classList.add('is-dark');
          html.classList.remove('is-light');
        }
        
        // Apply saved color
        html.style.setProperty('--color-primary', colorToApply);
      })();
    </script>
  </head>
  <body>
    <!-- TopBar: Only visible on screens < 1024px -->
    <TopBar />
    
    <div class="layout">
      <Sidebar currentPath={currentPath} />
      
      <div class="main-wrapper">
        <main class="main-container">
          <slot />
        </main>
      </div>
    </div>
    
    <!-- Persist theme and color across view transitions -->
    <script>
      // Apply theme BEFORE swap to prevent flash
      document.addEventListener('astro:before-swap', (event) => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        const newDocument = event.newDocument;
        
        // Apply theme class to incoming document
        if (savedTheme === 'light') {
          newDocument.documentElement.classList.add('is-light');
          newDocument.documentElement.classList.remove('is-dark');
        } else {
          newDocument.documentElement.classList.add('is-dark');
          newDocument.documentElement.classList.remove('is-light');
        }
        newDocument.documentElement.style.setProperty('color-scheme', savedTheme);
        
        // Apply color
        const colors: Record<string, string> = {
          'Lavender': 'var(--theme-lavender)',
          'Pink': 'var(--theme-pink)',
          'Yellow': 'var(--theme-yellow)',
          'Green': 'var(--theme-green)',
          'Blue': 'var(--theme-blue)'
        };
        const savedColorName = localStorage.getItem('theme-color');
        const savedColorVal = localStorage.getItem('color');
        let colorToApply = 'var(--theme-lavender)';
        if (savedColorName && colors[savedColorName]) {
          colorToApply = colors[savedColorName];
        } else if (savedColorVal) {
          colorToApply = savedColorVal;
        }
        newDocument.documentElement.style.setProperty('--color-primary', colorToApply);
      });

      document.addEventListener('astro:after-swap', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        
        // Define colors matching CSS variables
        const colors: Record<string, string> = {
          'Lavender': 'var(--theme-lavender)',
          'Pink': 'var(--theme-pink)',
          'Yellow': 'var(--theme-yellow)',
          'Green': 'var(--theme-green)',
          'Blue': 'var(--theme-blue)'
        };
        
        // Check both storage keys
        const savedColorName = localStorage.getItem('theme-color');
        const savedColorVal = localStorage.getItem('color');
        
        let colorToApply = 'var(--theme-lavender)';
        
        if (savedColorName && colors[savedColorName]) {
          colorToApply = colors[savedColorName];
        } else if (savedColorVal) {
          colorToApply = savedColorVal;
        }
        
        const html = document.documentElement;
        html.style.setProperty('color-scheme', savedTheme);
        
        if (savedTheme === 'light') {
          html.classList.add('is-light');
          html.classList.remove('is-dark');
        } else {
          html.classList.add('is-dark');
          html.classList.remove('is-light');
        }
        
        html.style.setProperty('--color-primary', colorToApply);
      });
    </script>
  </body>
</html>