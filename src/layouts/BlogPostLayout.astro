---
import BaseLayout from './BaseLayout.astro';
import TableOfContents from '../components/TableOfContents/TableOfContents.astro';
import type { MarkdownHeading, ImageMetadata } from 'astro';
import '../styles/global.css';
import Tag from '../components/ui/Tag.astro';
import { Image } from 'astro:assets';
import { resolveBlogIcon } from '../utils/blogIcon';

import RelatedPosts from '../components/RelatedPosts/RelatedPosts.astro';

interface PostLink {
  slug: string;
  title: string;
}

interface Props {
  title: string;
  description?: string;
  publishDate: Date | string;
  headings: MarkdownHeading[];
  tags?: string[];
  icon?: string | ImageMetadata;
  minutesRead?: string;
  prevPost?: PostLink | null;
  nextPost?: PostLink | null;
  slug?: string;
}

const { title, description, publishDate, headings, tags = [], icon, minutesRead, prevPost, nextPost, slug } = Astro.props;

// Format date nicely
const dateObj = new Date(publishDate);
const formattedDate = dateObj.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const iconSource = resolveBlogIcon(icon, dateObj);

// Get the current page path
const currentPath = Astro.url.pathname;
// Use prop slug or fall back to extracting from path (less reliable)
const currentSlug = slug || currentPath.split('/blog/')[1]?.replace(/\/$/, '') || '';
---

<BaseLayout title={title} description={description} currentPath={currentPath}>
  <div class="blog-post-layout">
    <article class="blog-content">
      <header class="post-header">
        <div class="header-icon">
          {typeof iconSource === 'string' ? (
            <img src={iconSource} alt={title} />
          ) : (
            <Image src={iconSource} alt={title} />
          )}
        </div>

        <div class="header-content">
          <h1 class="post-title" id="introduction">{title}</h1>
          
          {/* Tags as styling chips */
           tags.length > 0 && (
            <div class="tag-pills">
              {tags.map(tag => (
                <Tag tag={tag} />
              ))}
            </div>
          )}

          <div class="post-meta">
            <time datetime={publishDate.toString()}>{formattedDate}</time>
            {minutesRead && (
              <>
                <span class="meta-dot">•</span>
                <span>{minutesRead}</span>
              </>
            )}
          </div>
        </div>
      </header>
      
      <div class="markdown">
        <slot />
      </div>

      {/* Previous / Next Navigation */}
      {(prevPost || nextPost) && (
        <nav class="post-navigation">
          <div class="post-nav-link post-nav-prev">
            {prevPost && (
              <a href={`/blog/${prevPost.slug}`}>
                <span class="post-nav-label">← Previous</span>
                <span class="post-nav-title">{prevPost.title}</span>
              </a>
            )}
          </div>
          <div class="post-nav-link post-nav-next">
            {nextPost && (
              <a href={`/blog/${nextPost.slug}`}>
                <span class="post-nav-label">Next →</span>
                <span class="post-nav-title">{nextPost.title}</span>
              </a>
            )}
          </div>
        </nav>
      )}
    </article>
    
    <aside class="toc-sidebar">
      <TableOfContents headings={headings} />
      <RelatedPosts currentSlug={currentSlug} tags={tags} />
    </aside>
  </div>
</BaseLayout>

<style>
  .blog-post-layout {
    display: grid;
    grid-template-columns: minmax(0, 1fr);
    gap: var(--space-8);
  }
  
  @media (min-width: 1024px) {
    .blog-post-layout {
      grid-template-columns: minmax(0, 1fr) 260px; /* Flexible content, fixed sidebar */
      justify-content: space-between; /* Space out if there's extra room, though max-width handles it */
      gap: var(--space-12);
    }
  }

  .blog-content {
    padding-inline: var(--space-4);
  }

  .post-header {
    margin-bottom: var(--space-10);
    display: flex;
    align-items: center;
    gap: var(--space-6);
  }

  .header-icon {
    flex-shrink: 0;
    width: 150px;
    height: 150px;
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .header-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .header-content {
    flex: 1;
    min-width: 0;
  }

  .post-title {
    font-size: var(--font-size-4xl);
    line-height: 1.2;
    margin-bottom: var(--space-2);
  }

  .tag-pills {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-1);
    margin-bottom: var(--space-2);
  }

  .post-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-secondary);
    font-size: var(--font-size-xs);
    padding-left: 2px;
  }

  .meta-dot {
    font-weight: bold;
  }

  .toc-sidebar {
    padding-top: var(--space-40);
  }

  /* On mobile, sidebar takes no layout space (mini indicator is fixed position) */
  @media (max-width: 1024px) {
    .toc-sidebar {
      position: static;
      width: 0;
      height: 0;
      padding: 0;
      overflow: visible; /* Allow fixed children to show */
    }
  }

  /* Responsive styles */
  @media (max-width: 1024px) {
    .header-icon {
      width: 100px;
      height: 100px;
    }

    .post-title {
      font-size: var(--font-size-3xl);
    }
  }

  @media (max-width: 768px) {
    /* Use CSS Grid for reflow - icon+title on row 1, tags+meta on row 2 */
    .post-header {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      grid-template-rows: auto auto;
      gap: var(--space-3) var(--space-4);
      align-items: center;
    }

    .header-icon {
      width: 76px;
      height: 76px;
      grid-row: 1;
      grid-column: 1;
    }

    .header-content {
      display: contents; /* Children participate in parent grid */
    }

    .post-title {
      grid-row: 1;
      grid-column: 2;
      margin-bottom: 0;
    }

    .tag-pills {
      grid-row: 2;
      grid-column: 1 / -1; /* Span full width */
      margin-bottom: 0;
    }

    .post-meta {
      grid-row: 3;
      grid-column: 1 / -1; /* Span full width */
    }
  }

  @media (max-width: 430px) {
    .header-icon {
      width: 50px;
      height: 50px;
      grid-row: 1;
      grid-column: 1;
    }
    .post-title {
      font-size: var(--font-size-2xl);
    }
  }

  /* Post Navigation */
  .post-navigation {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-12);
    margin-top: var(--space-12);
  }

  .post-nav-link {
    display: flex;
  }

  .post-nav-link a {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    padding: var(--space-3);
    border-radius: var(--radius-md);
    background-color: transparent;
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: all var(--transition-fast);
    width: 100%;
  }

  .post-nav-link a:hover {
    background-color: var(--color-bg);
    border-color: var(--color-primary);
  }

  .post-nav-link a:hover .post-nav-label {
    color: var(--color-primary);
  }

  .post-nav-prev {
    justify-content: flex-start;
  }

  .post-nav-prev a {
    align-items: flex-start;
  }

  .post-nav-next {
    justify-content: flex-end;
  }

  .post-nav-next a {
    align-items: flex-end;
    text-align: right;
  }

  .post-nav-label {
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
    font-weight: 500;
  }

  .post-nav-title {
    font-size: var(--font-size-sm);
    color: var(--color-text);
    font-weight: 600;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media (max-width: 600px) {
    .post-navigation {
      grid-template-columns: 1fr;
      gap: var(--space-3);
    }

    .post-nav-next a {
      align-items: flex-start;
      text-align: left;
    }

    .post-nav-next .post-nav-label {
      order: -1;
    }
  }
</style>
